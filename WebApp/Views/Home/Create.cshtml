@model SAP_MIMOSAapp.Models.MappingDocument

@{
    ViewData["Title"] = "Create Mapping";
}

<div class="container mt-4">
    <h2>Create New Mapping</h2>

    @if (!string.IsNullOrEmpty(ViewBag.ErrorMessage))
    {
        <div class="alert alert-danger">
            @ViewBag.ErrorMessage
        </div>
    }



    <form asp-action="Create" method="post">
        @if (!string.IsNullOrEmpty(ViewBag.SuccessMessage))
        {
            <div class="alert alert-success">@ViewBag.SuccessMessage</div>
        }
        <div class="card mb-4">
            <div class="card-header">
                <h5>Mapping Details</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="ai-mapping-search-area mb-4">
                        @* <div class="search-bar-container d-flex flex-wrap align-items-center shadow-lg rounded-pill px-4 py-3 bg-white position-relative" style=" border: 2px solid #00e6a6; box-shadow: 0 4px 32px 0 #00e6a6aa;"> *@
                        <div class="search-bar-container d-flex  align-items-center shadow-lg rounded-pill px-4 py-3 bg-white" style=" border: 2px solid #00e6a6; box-shadow: 0 4px 32px 0 #00e6a6aa;">
                            <i class="bi bi-search fs-4 text-primary"></i>
                            <input asp-for="prompt" type="text" id="aiPrompt" class="form-control border-0 bg-transparent fs-5 px-3" placeholder="Enter prompt to generate initial mapping" style="max-width: 445px; background: none; box-shadow: none; outline: none;" />
                            <select asp-for="LLMType" id="aiLLMType" class="form-select border-0 bg-transparent fs-6 px-2" style="margin-left: 1.5rem; max-width: 120px; background: none; box-shadow: none; outline: none;">
                                @foreach (var item in SAP_MIMOSAapp.Models.SearchViewModel.AvailableLLMs)
                                {
                                    <option value="@item.Value">@item.Text</option>
                                }
                            </select>
                            <button type="button" class="btn btn-gradient-glow d-flex align-items-center gap-1 px-4 py-2 fw-bold fs-5" id="askAiBtn" style="margin-left: 0.8rem; box-shadow: 0 0 18px 2px #00e6a6cc, 0 0 8px 2px #1976D2aa; border-radius: 2rem; background: linear-gradient(90deg,#00e6a6 60%,#1976D2 100%); color: #fff; border: none;">
                                <i class="bi bi-stars"></i> Ask AI
                            </button>
                            <div class="vr mx-4 d-none d-md-block" style="height: 2.5rem;"></div>
                            <div class="d-flex align-items-center gap-2 ms-auto upload-section">
                                <input type="file" class="form-control d-none" id="csvFileInput" accept=".csv">
                                <label for="csvFileInput" id="csvLabel" class="btn btn-outline-secondary  align-items-center gap-1 mb-0 rounded-pill px-3 py-2" style="background: linear-gradient(90deg,#fff 60%,#00e6a6 100%); border: 1.5px solid #00e6a6; max-width: 220px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    <i class="bi bi-upload"></i>
                                    <span id="csvLabelText" style="display: inline-block; vertical-align: middle;">Choose CSV</span>
                                </label>
                                <button type="button" class="btn btn-success d-flex align-items-center gap-1 rounded-pill px-4 py-2 fw-bold" id="importCsvBtn" style="box-shadow: 0 0 10px 2px #00e6a6aa;">
                                    <i class="bi bi-box-arrow-in-down"></i> Import
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex ms-auto">
                        <label class="small text-muted">
                            <input type="checkbox" name="checkBx" id="checkBx" @(Model?.mappings == null || Model.mappings.Count == 0 ? "disabled" : "") /> Re-use Existing Mapping
                        </label>
                        <a href="@Url.Action("Create", "Home")" class="btn btn-outline-danger ms-auto  d-flex align-items-center gap-1 px-4 py-2 fw-bold fs-5 rounded-pill ms-2" id="clearPageBtn" style="border-width: 2px;">
                            <i class="bi bi-eraser fs-4"></i> Clear
                        </a>                        
                    </div>
                    <span asp-validation-for="LLMType" class="text-danger mt-1 d-block"></span>
                    <div>
                        <div id="aiResponseArea" class="mb-2"></div>
                        <div id="importLoading" class=" mb-2"></div>
                    </div>
                </div>
            </div>
        </div>
        @* Metrics alert is always present but hidden if no metrics *@
        <div class="alert alert-info mb-3" id="metricsAlert" style="display:@((Model?.accuracyResult?.accuracyRate != null) ? "block" : "none")">

            @if (Model?.prompts != null && Model.prompts.Any())
            {
                <div class="section">
                    <h5>Prompt History</h5>
                    <ul>
                        @foreach (var prompt in Model.prompts)
                        {
                            <li>@prompt</li>
                        }
                    </ul>
                </div>
            }

            Overall Accuracy: <span class="badge @(Model?.accuracyResult?.accuracyRate < 35 ? "bg-danger" : (Model?.accuracyResult?.accuracyRate < 70 ? "bg-warning text-dark" : "bg-success"))">
                <strong>@Html.DisplayFor(m => m.accuracyResult.accuracyRate)%</strong>
            </span> <br />
            Description Similarity: <strong>@Html.DisplayFor(m => m.accuracyResult.descriptionSimilarity)%</strong> <br />
            MIMOSA Similiraty: <strong>@Html.DisplayFor(m => m.accuracyResult.mimosaSimilarity)%</strong><br />
            SAP Similiraty: <strong>@Html.DisplayFor(m => m.accuracyResult.sapSimilarity)%</strong><br />
            Data type similarity: <strong>@Html.DisplayFor(m => m.accuracyResult.dataType)%</strong><br />
            Missing fields rate: <strong>@Html.DisplayFor(m => m.accuracyResult.infoOmitted)%</strong><br />
            Field length similarity: <strong>@Html.DisplayFor(m => m.accuracyResult.fieldLength)%</strong><br />
        </div>

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Mapping Pairs</h5>
                <div class="d-flex align-items-center gap-2">

                    <button type="button" class="btn btn-sm btn-primary" id="addMapping">Add Mapping</button>
                </div>
            </div>

            @if (Model?.mappings != null && Model.mappings.Count > 0)
            {
                <div class="card-body" id="mappingsContainer" style="max-height: 800px; overflow-y: auto;">
                    @{
                        var mappingIndex = 0;
                        // Pass accuracySingleMappingPair to the partial via ViewData
                        ViewData["AccuracyaccuracySingleMappingPair"] = Model.accuracySingleMappingPair;
                        foreach (var mapping in Model.mappings)
                        {
                            @await Html.PartialAsync("_MappingPair", Tuple.Create(mappingIndex, mapping), new ViewDataDictionary(ViewData))
                            mappingIndex++;
                        }
                    }
                </div>
            }
            @{
                var accuracySingleMappingPairJson = Newtonsoft.Json.JsonConvert.SerializeObject(Model?.accuracySingleMappingPair ?? new List<SAP_MIMOSAapp.Models.AccuracyResultViewModel>());
            }
            <input type="hidden" id="accuracySingleMappingPairJson" name="accuracySingleMappingPairJson" value='@accuracySingleMappingPairJson' />
        </div>

        @* <input type="hidden" asp-for="prompt" /> *@
        @* <input type="hidden" asp-for="LLMType" /> *@
        <input type="hidden" asp-for="accuracyResult.accuracyRate" />
        <input type="hidden" asp-for="accuracyResult.descriptionSimilarity" />
        <input type="hidden" asp-for="accuracyResult.mimosaSimilarity" />
        <input type="hidden" asp-for="accuracyResult.sapSimilarity" />
        <input type="hidden" asp-for="accuracyResult.dataType" />
        <input type="hidden" asp-for="accuracyResult.fieldLength" />
        <input type="hidden" asp-for="accuracyResult.infoOmitted" />
        <input type="hidden" id="prompts" asp-for="prompts" value="@(Model?.prompts != null ? string.Join(",", Model.prompts) : "")" />
        <div class="d-flex justify-content-between mb-4">
            <a asp-action="Index" class="btn btn-secondary">Back to List</a>
            <button type="submit" class="btn btn-primary" @(Model?.mappings == null || Model.mappings.Count == 0 ? "disabled" : "")>Create</button>
        </div>
    </form>
</div>

@section Scripts {

    <!-- Template for mapping pair for JS to clone and insert blank mapping rows dynamically -->
    <script type="text/template" id="mappingPairTemplate">
        @await Html.PartialAsync("_MappingPair", Tuple.Create(-1, new SAP_MIMOSAapp.Models.MappingPair { sap = new SAP_MIMOSAapp.Models.MappingField(), mimosa = new SAP_MIMOSAapp.Models.MappingField() }))
    </script>

    <script>

        // Check box changes placeholder text of 'Prompt' input
        const mappingCheckBx = document.getElementById('checkBx');
        const aiPrompt = document.getElementById('aiPrompt');

        mappingCheckBx.addEventListener('change', () => {
            aiPrompt.placeholder = mappingCheckBx.checked ? "Provide feedback to improve existing mapping" : "Enter prompt to generate initial mapping";
        });


        // --- AI Assistant logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const aiPrompt = document.getElementById('aiPrompt');
            const aiLLMType = document.getElementById('aiLLMType');
            const askAiBtn = document.getElementById('askAiBtn');
            const aiResponseArea = document.getElementById('aiResponseArea');
            

            // Ask AI button
            askAiBtn?.addEventListener('click', async () => {
                aiResponseArea.innerHTML = '';
                const prompt = aiPrompt.value.trim();
                const llmType = aiLLMType.value;
                const useExisting = document.getElementById('checkBx').checked;

                // Alert when click AskAI btn and  llmtype and prompt are empty
                if (!prompt || !llmType) {
                    aiResponseArea.innerHTML = `<div class="alert alert-danger">${!prompt ? 'Please enter a prompt.' : ''}
                    ${!prompt && !llmType ? '<br>' : ''}${!llmType ? 'Please select a model.' : ''}</div>`;
                    return;
                } 
                

                const requestBody = { prompt, llmType };

                // If "Use Existing Mapping" checkbox is checked, collect existing mapping pairs and add in request
                if (useExisting) {
                    const mappings = [];
                    document.querySelectorAll('.mapping-pair').forEach(pair => {
                        const getValue = name => pair.querySelector(`[name*="${name}"]`)?.value || "";

                        mappings.push({
                            sap: {
                                platform: getValue('sap.platform'),
                                entityName: getValue('sap.entityName'),
                                fieldName: getValue('sap.fieldName'),
                                description: getValue('sap.description'),
                                dataType: getValue('sap.dataType'),
                                notes: getValue('sap.notes'),
                                fieldLength: getValue('sap.fieldLength'),
                            },
                            mimosa: {
                                platform: getValue('mimosa.platform'),
                                entityName: getValue('mimosa.entityName'),
                                fieldName: getValue('mimosa.fieldName'),
                                description: getValue('mimosa.description'),
                                dataType: getValue('mimosa.dataType'),
                                notes: getValue('mimosa.notes'),
                                fieldLength: getValue('mimosa.fieldLength'),
                            }
                        });           
                    });
                        
                    requestBody.mappings = mappings;

                }

                // Read existing prompts from hidden input                
                const hiddenPromptInput = document.getElementById('prompts');
                let existingPrompts = hiddenPromptInput?.value?.split('\n').filter(p => p.trim()) || [];

                // Add the new prompt to history if improving existing mapping
                if (useExisting) {
                    existingPrompts.push(prompt);
                } else {
                    existingPrompts = [prompt];
                }
                // Update the hidden input value
                if (hiddenPromptInput) {
                    hiddenPromptInput.value = existingPrompts.join('\n');
                }
                requestBody.prompts = existingPrompts;

                // Send request to AI
                aiResponseArea.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden"></span></div>';
                try {
                    const resp = await fetch('/Home/AskAI', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify( requestBody )
                    });
                    const data = await resp.json();
                    if (data.success && data.redirectUrl) {
                        window.location.href = data.redirectUrl;
                    } else if (data.message) {
                        aiResponseArea.innerHTML = '<div class="alert alert-danger">' + data.message + '</div>';
                    } else {
                        aiResponseArea.innerHTML = '<div class="alert alert-danger">AI did not return a valid mapping.</div>';
                    }
                } catch (e) {
                    aiResponseArea.innerHTML = '<div class="alert alert-danger">Error communicating with AI: ' + e + '</div>';
                }
            });


            // --- Existing mapping  logic ---
            // Attach remove event to a mapping pair
            const attachRemoveHandler = el => {
                el.querySelector('.remove-mapping')?.addEventListener('click', () => {
                    el.remove();
                    renumberMappings();
                });
            };

            // Renumber mapping input names for proper model binding. e.g. use this method to update indexes when update imported mapping pairs
            const renumberMappings = () => {
                document.querySelectorAll('.mapping-pair').forEach((pair, idx) => {
                    pair.querySelectorAll('input, textarea').forEach(field => {
                        field.name = field.name.replace(/mappings\[\d+\]/g, `mappings[${idx}]`);
                    });
                });
            };

            let mappingIndex = @(Model?.mappings != null ? Model.mappings.Count : 0);
            const mappingsContainer = document.getElementById('mappingsContainer');
            const template = document.getElementById('mappingPairTemplate').textContent;

            // Attach remove handler to all mapping pairs
            document.querySelectorAll('.mapping-pair').forEach(attachRemoveHandler);

            // Add new mapping pair button
            document.getElementById('addMapping').addEventListener('click', () => {
                addMappingPair();
                renumberMappings();
            });

            // Add a new mapping pair
            function addMappingPair(mappingData) {
                const newMapping = template.replace(/\[@Model\.Item1\]|\[-1\]/g, `[${mappingIndex}]`);
                const mappingElement = document.createElement('div');
                mappingElement.innerHTML = newMapping;
                attachRemoveHandler(mappingElement);
                if (mappingData) {
                    ["sap", "mimosa"].forEach(type => {
                        ["entityName", "fieldName", "dataType", "description", "fieldLength", "notes", "platform"].forEach(field => {
                            // Handle both inputs and textareas
                            const input = mappingElement.querySelector(`[name$=\".${type}.${field}\"]`);
                            if (input && mappingData[type] && mappingData[type][field] !== undefined) {
                                if (input.tagName.toLowerCase() === 'textarea') {
                                    input.textContent = mappingData[type][field];
                                } else {
                                    input.value = mappingData[type][field];
                                }
                            }
                        });
                    });
                    const allSapFilled = ["entityName", "fieldName", "dataType", "description"].every(f => (mappingData.sap?.[f] || '').trim() !== '');
                    const allMimosaFilled = ["entityName", "fieldName", "dataType", "description"].every(f => (mappingData.mimosa?.[f] || '').trim() !== '');
                    if (!allSapFilled && !allMimosaFilled) return;
                }
                mappingsContainer.appendChild(mappingElement);
                mappingIndex++;
            }

             // --- CSV Import logic ---
            document.getElementById('importCsvBtn')?.addEventListener('click', event => {
                event.preventDefault();
                const fileInput = document.getElementById('csvFileInput');
                if (!fileInput.files.length) {return importLoading.innerHTML = '<div class="alert alert-danger">Please select a CSV file.</div>';}
                const formData = new FormData();
                formData.append('csvFile', fileInput.files[0]);
                importLoading.innerHTML = '<div class="spinner-border text-success" role="status"><span class="visually-hidden"></span></div>';
                fetch('/Home/ImportCsv', { method: 'POST', body: formData })
                    .then(resp => resp.ok ? resp.json() : Promise.reject('Failed to import CSV.'))
                    .then(data => {
                        if (data.redirectUrl) {
                            window.location.href = data.redirectUrl;
                        } else {
                            alert('Invalid response from server.');
                        }
                    })
                    .catch(error => alert('Error importing CSV: ' + error));
            });

            // Display file name of imported file
            const fileInput = document.getElementById('csvFileInput');
            const labelSpan = document.getElementById('csvLabel');

            fileInput.addEventListener('change', function () {
                if (this.files.length > 0) {
                    labelSpan.textContent = this.files[0].name;
                    labelSpan.title = this.files[0].name;
                } else {
                    labelSpan.textContent = "Choose CSV";
                }
            });            
        });
    </script>
}
@model SAP_MIMOSAapp.Models.SearchViewModel


<div class="container py-4">
    <h1 class="mb-4">Generate Mapping Between SAP PM & MIMOSA</h1>

    <div class="section">
        <div class="row">
            <div class="col-md-12 mb-4">
                <!-- Search Controls -->
                <div class="card search-card p-0 overflow-hidden border-0 shadow-lg">
                    <div class="card-header bg-gradient text-white d-flex align-items-center" style="background: linear-gradient(90deg, #4CAF50 60%, #00e6a6 100%); box-shadow: 0 4px 24px 0 #00e6a6a0;">
                        <i class="bi bi-search me-2 fs-3"></i>
                        <h4 class="mb-0 flex-grow-1">
                            Search Mappings

                            @if (TempData["SuccessMessage"] != null)
                            {
                                <span id="success-message" class="m-5 alert alert-success" role="alert">
                                    @TempData["SuccessMessage"]
                                </span>
                            }
                        </h4>

                        <a href="@Url.Action("Create", "Home")" class="btn btn-floating-create ms-auto d-none d-md-inline-block" title="Create New Mapping">
                            <i class="bi bi-plus-lg"></i>
                        </a>
                    </div>
                    <div class="card-body bg-glassmorph">
                        <div class="row align-items-end g-3">
                            <div class="col-md-7">
                                <form id="mappingSearchForm" method="get" asp-action="Index">
                                    <div class="d-flex align-items-center mb-4 gap-3">
                                        <div class="position-relative flex-grow-1">
                                            <input type="text" id="searchInput" name="SearchInput" class="form-control search-input px-4 py-3 shadow-sm pe-5" placeholder="" value="@(string.IsNullOrEmpty(Model.SearchByLLM) ? Model.SearchByEntityName : Model.SearchByLLM)" />
                                            <label for="searchInput" class="search-label" id="search-label"></label>
                                            <div class="position-absolute top-50 end-0 translate-middle-y d-flex align-items-center me-2" style="z-index:2; gap:0.25rem;">
                                                <button type="submit" class="btn btn-gradient search-embedded-btn" style="padding: 0.375rem 0.85rem; border-radius: 0.7rem;" tabindex="-1">
                                                    <i>Search</i>
                                                </button>
                                            </div>
                                        </div>
                                        <div>
                                            <a href="@Url.Action("Index", "Home")" class="btn btn-outline-light ms-2 px-4 py-2">Clear</a>
                                        </div>
                                    </div>
                                    <p id="searchInputError" class="invalid-feedback" style="display:none;"></p>
                                    <div class="mb-4 d-flex gap-4 align-items-center">
                                        <div class="form-check form-check-inline search-radio">
                                            <input class="form-check-input" type="radio" name="SearchType" id="searchEntityName" value="EntityName" @(string.IsNullOrEmpty(Model.SearchByLLM) ? "checked" : "")>
                                            <label class="form-check-label" for="searchEntityName"><i class="bi bi-diagram-3"></i> Entity Name</label>
                                        </div>
                                        <div class="form-check form-check-inline search-radio">
                                            <input class="form-check-input" type="radio" name="SearchType" id="searchLLMType" value="LLMType" @(!string.IsNullOrEmpty(Model.SearchByLLM) ? "checked" : "")>
                                            <label class="form-check-label" for="searchLLMType"><i class="bi bi-cpu"></i> LLM Type</label>
                                        </div>
                                    </div>
                                    @if (!string.IsNullOrEmpty(Model.SearchByEntityName) || !string.IsNullOrEmpty(Model.SearchByLLM))
                                    {
                                        <div class="mt-2">
                                            <small class="text-muted">
                                                Found @Model.FilteredCount mapping@(Model.FilteredCount > 1 ? "s" : "") out of @Model.TotalDocuments total mappings.
                                            </small>
                                        </div>
                                    }
                                </form>
                            </div>
                            <div class="col-md-3 text-end d-md-none">
                                <a href="@Url.Action("Create", "Home")" class="btn btn-floating-create" title="Create New Mapping">
                                    <i class="bi bi-plus-lg"></i> Create New Mapping
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Display Mappings-->
    @if ((Model.SearchResults != null && Model.SearchResults.Count > 0)
    || !string.IsNullOrEmpty(Model.SearchByEntityName)
    || !string.IsNullOrEmpty(Model.SearchByLLM))
    {

        @if (Model.SearchResults.Count == 0)
        {

            <p class="text-center">No mappings found.</p>

        }
        else
        {
            <div id="mappings-container">
                @foreach (var document in Model.SearchResults)
                {
                    <div class="card mapping-card" id="group-@document.mapID">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="d-flex align-items-center gap-2">
                                        <h5 class="mb-0">@document.mapID</h5>
                                        <span class="badge badge-outline">@document.LLMType</span>
                                    </div>
                                    <small class="text-muted">@document.mappings.Count field mapping@(document.mappings.Count > 1 ? "s" : "")</small>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-secondary btn-sm" onclick="toggleDetails('@document.mapID')">
                                        <i class="bi bi-chevron-down details-icon-@document.mapID"></i>
                                        Details
                                    </button>
                                    <a href="@Url.Action("Edit", "Home", new { id = document.mapID })" class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-pencil"></i>
                                        Edit
                                    </a>

                                    <button class="btn btn-outline-danger btn-sm delete-btn" data-mapid="@document.mapID">
                                        <i class="bi bi-trash"></i>
                                        Delete
                                    </button>

                                    <a href="@Url.Action("ExportMappingCsv", "Home", new { mapId = document.mapID })" class="btn btn-outline-warning btn-sm">
                                        <i class="bi bi-download"></i>
                                        Export
                                    </a>
                                </div>
                            </div>
                        </div>

                        <div class="card-body">
                            <!-- Tabs Navigation -->
                            <ul class="nav nav-tabs" id="viewTabs-@document.mapID" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="table-tab-@document.mapID" data-bs-toggle="tab"
                                            data-bs-target="#table-view-@document.mapID" type="button" role="tab" aria-selected="true">
                                        Table View
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="card-tab-@document.mapID" data-bs-toggle="tab"
                                            data-bs-target="#card-view-@document.mapID" type="button" role="tab" aria-selected="false">
                                        Card View
                                    </button>
                                </li>
                            </ul>
                            <div class="row">
                                <!-- Details Section (Collapsible) -->
                                <div id="details-@document.mapID" class="details-row border-top bg-light">
                                    <div class="card m-3 shadow-sm border-info">
                                        <div class="card-header bg-info text-white">
                                            <i class="bi bi-info-circle-fill me-2"></i>
                                            <strong>Mapping Details</strong>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6 mb-3 border-end">
                                                    <h5 class="mb-3"><i class="bi bi-chat-text me-2"></i>Prompt History</h5>
                                                    @if (document.promptHistory != null && document.promptHistory.Any())
                                                    {
                                                        <ul class="list-group list-group-flush">
                                                            @foreach (var prompt in document.promptHistory)
                                                            {
                                                                <li class="list-group-item bg-transparent prompt-history-item d-flex justify-content-between align-items-center py-2 px-2"
                                                                    data-createdat="@prompt.createdAt?.ToString("o")"
                                                                    data-mapid="@document.mapID"
                                                                    data-source="@((prompt.text == "Modified Manually") ? "sapmimosa" : "raw")"
                                                                    style="cursor:pointer; border-radius: 0.4rem; transition: background 0.15s; color:#0d6efd;">
                                                                    <span class="d-flex align-items-center">
                                                                        <i class="bi bi-chat-left-text me-2 text-primary"></i>
                                                                        <span class="fw-semibold fs-6 text-decoration-underline" style="width:400px;">@prompt.text</span>
                                                                    </span>
                                                                    <span class="text-muted small text-nowrap ">@prompt.createdAt?.ToString("yyyy-MM-dd HH:mm:ss")</span>
                                                                </li>
                                                            }
                                                        </ul>
                                                    }
                                                    else
                                                    {
                                                        <p class="text-muted">No prompt history available.</p>
                                                    }
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <h5 class="mb-3"><i class="bi bi-bar-chart-fill me-2" style="color: #0d6efd;"></i>Accuracy Metrics</h5>
                                                    @if (document.accuracyResult != null)
                                                    {

                                                        <div class="mb-3">
                                                            <div class="d-flex justify-content-between mb-1">
                                                                <span class="fw-medium">
                                                                    Overall Accuracy Rate
                                                                    <i class="bi bi-info-circle ms-1 text-primary" data-bs-toggle="tooltip"
                                                                       title="A total accuracy score is calculated by taking the metrics, SAP Schema Similarity, MIMOSA Schema Similarity, Description Similarity and Data type Similarity but not Table coverage and averaging their scores."></i>
                                                                </span>
                                                                <span>@Html.DisplayFor(m => document.accuracyResult.accuracyRate)%</span>
                                                            </div>
                                                            <div class="progress">
                                                                <div class="progress-bar bg-success" role="progressbar"
                                                                     style="width: @(document.accuracyResult.accuracyRate)%"
                                                                     aria-valuenow="@document.accuracyResult.accuracyRate" aria-valuemin="0" aria-valuemax="100"></div>
                                                            </div>
                                                        </div>

                                                        <div class="mb-3">
                                                            <div class="d-flex justify-content-between mb-1">
                                                                <span class="fw-medium">
                                                                    Description Similarity
                                                                    <i class="bi bi-info-circle ms-1 text-primary" data-bs-toggle="tooltip"
                                                                       title="Description similarity compares the meaning of descriptions across a mapping to see if the fields are likely to contain similar information"></i>
                                                                </span>
                                                                <span>
                                                                    @Html.DisplayFor(m => document.accuracyResult.descriptionSimilarity)%

                                                                </span>
                                                            </div>
                                                            <div class="progress">
                                                                <div class="progress-bar bg-primary" role="progressbar"
                                                                     style="width: @(document.accuracyResult.descriptionSimilarity)%"
                                                                     aria-valuenow="@document.accuracyResult.descriptionSimilarity" aria-valuemin="0" aria-valuemax="100"></div>
                                                            </div>
                                                        </div>

                                                        <div class="mb-3">
                                                            <div class="d-flex justify-content-between mb-1">
                                                                <span class="fw-medium">
                                                                    MIMOSA Schema Similarity
                                                                    <i class="bi bi-info-circle ms-1 text-primary" data-bs-toggle="tooltip"
                                                                       title="MIMOSA Schema similarity compares the MIMOSA side of the mapping to to the schema to see if it is a valid field."></i>
                                                                </span>
                                                                <span>@Html.DisplayFor(m => document.accuracyResult.mimosaSimilarity)%</span>
                                                            </div>
                                                            <div class="progress">
                                                                <div class="progress-bar bg-info" role="progressbar"
                                                                     style="width: @(document.accuracyResult.mimosaSimilarity)%"
                                                                     aria-valuenow="@document.accuracyResult.mimosaSimilarity" aria-valuemin="0" aria-valuemax="100"></div>
                                                            </div>
                                                        </div>

                                                        <div class="mb-3">
                                                            <div class="d-flex justify-content-between mb-1">
                                                                <span class="fw-medium">
                                                                    SAP Schema Similarity
                                                                    <i class="bi bi-info-circle ms-1 text-primary" data-bs-toggle="tooltip"
                                                                       title="SAP schema similarity compares the SAP side of the mapping to to the schema to see if it is a valid field"></i>
                                                                </span>
                                                                <span>@Html.DisplayFor(m => document.accuracyResult.sapSimilarity)%</span>
                                                            </div>
                                                            <div class="progress">
                                                                <div class="progress-bar bg-info" role="progressbar"
                                                                     style="width: @(document.accuracyResult.sapSimilarity)%"
                                                                     aria-valuenow="@document.accuracyResult.sapSimilarity" aria-valuemin="0" aria-valuemax="100"></div>
                                                            </div>
                                                        </div>

                                                        <div class="mb-3">
                                                            <div class="d-flex justify-content-between mb-1">
                                                                <span class="fw-medium">
                                                                    Data Type Similarity
                                                                    <i class="bi bi-info-circle ms-1 text-primary" data-bs-toggle="tooltip"
                                                                       title="DataType compares the data type between mapped fields to see if they are likely to be able to contain similar data."></i>
                                                                </span>
                                                                <span>@Html.DisplayFor(m => document.accuracyResult.dataType)%</span>
                                                            </div>
                                                            <div class="progress">
                                                                <div class="progress-bar bg-warning" role="progressbar"
                                                                     style="width: @(document.accuracyResult.dataType)%"
                                                                     aria-valuenow="@document.accuracyResult.dataType" aria-valuemin="0" aria-valuemax="100"></div>
                                                            </div>
                                                        </div>

                                                        <div class="mb-3">
                                                            <div class="d-flex justify-content-between mb-1">
                                                                <span class="fw-medium">
                                                                    Table Coverage
                                                                    <i class="bi bi-info-circle ms-1 text-primary" data-bs-toggle="tooltip"
                                                                       title="Indicates the percentage of base tables that are currently covered by defined mappings."></i>
                                                                </span>
                                                                <span>@Html.DisplayFor(m => document.accuracyResult.infoOmitted)%</span>
                                                            </div>
                                                            <div class="progress">
                                                                <div class="progress-bar bg-danger" role="progressbar"
                                                                     style="width: @(document.accuracyResult.infoOmitted)%"
                                                                     aria-valuenow="@document.accuracyResult.infoOmitted" aria-valuemin="0" aria-valuemax="100"></div>
                                                            </div>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <p class="text-muted">No accuracy metrics available.</p>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tab Content -->
                            <div class="tab-content" id="viewTabsContent-@document.mapID">
                                <!-- Table View -->
                                <div class="tab-pane fade show active table-view" id="table-view-@document.mapID" role="tabpanel">
                                    <div class="table-responsive">
                                        <table class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th colspan="5" class="text-center sap-table-header">SAP</th>
                                                    <th colspan="5" class="text-center mimosa-table-header">MIMOSA</th>
                                                </tr>
                                                <tr>
                                                    <th>Table Name</th>
                                                    <th>Field Name</th>
                                                    <th>Description</th>
                                                    <th>Data Type</th>
                                                    <th class="border-right-thick">Length</th>
                                                    <th>Table Name</th>
                                                    <th>Field Name</th>
                                                    <th>Description</th>
                                                    <th>Data Type</th>
                                                    <th>Length</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var mapping in document.mappings)
                                                {
                                                    <tr>
                                                        <td>@mapping.sap.entityName</td>
                                                        <td class="fw-medium">@mapping.sap.fieldName</td>
                                                        <td>@mapping.sap.description</td>
                                                        <td>@mapping.sap.dataType</td>
                                                        <td class="border-right-thick">@mapping.sap.fieldLength</td>
                                                        <td>@mapping.mimosa.entityName</td>
                                                        <td class="fw-medium">@mapping.mimosa.fieldName</td>
                                                        <td>@mapping.mimosa.description</td>
                                                        <td>@mapping.mimosa.dataType</td>
                                                        <td>@mapping.mimosa.fieldLength</td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Card View -->
                                <div class="tab-pane fade card-view" id="card-view-@document.mapID" role="tabpanel">
                                    <div class="row">
                                        @foreach (var mapping in document.mappings)
                                        {
                                            <div class="col-12 mb-3">
                                                <div class="card mapping-pair-card">
                                                    <div class="card-header d-flex justify-content-between align-items-center">
                                                        <h6 class="mb-0">Mapping Pair</h6>
                                                        <div class="badge bg-light text-dark">Field Mapping</div>
                                                    </div>
                                                    <div class="card-body p-0">
                                                        <div class="row g-0">
                                                            <!-- SAP Side -->
                                                            <div class="col-md-6 sap-side">
                                                                <div class="p-3 h-100 border-end-md">
                                                                    <div class="d-flex align-items-center mb-3">
                                                                        <div class="sap-indicator me-2"></div>
                                                                        <h6 class="mb-0">SAP</h6>
                                                                    </div>
                                                                    <div class="mapping-details">
                                                                        <div class="mapping-item">
                                                                            <div class="mapping-label">Table:</div>
                                                                            <div class="mapping-value">@mapping.sap.entityName</div>
                                                                        </div>
                                                                        <div class="mapping-item">
                                                                            <div class="mapping-label">Field:</div>
                                                                            <div class="mapping-value fw-semibold">@mapping.sap.fieldName</div>
                                                                        </div>
                                                                        <div class="mapping-item">
                                                                            <div class="mapping-label">Description:</div>
                                                                            <div class="mapping-value">@mapping.sap.description</div>
                                                                        </div>
                                                                        <div class="mapping-item">
                                                                            <div class="mapping-label">Data Type:</div>
                                                                            <div class="mapping-value">@mapping.sap.dataType</div>
                                                                        </div>
                                                                        <div class="mapping-item">
                                                                            <div class="mapping-label">Length:</div>
                                                                            <div class="mapping-value">@mapping.sap.fieldLength</div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <!-- MIMOSA Side -->
                                                            <div class="col-md-6 mimosa-side">
                                                                <div class="p-3 h-100">
                                                                    <div class="d-flex align-items-center mb-3">
                                                                        <div class="mimosa-indicator me-2"></div>
                                                                        <h6 class="mb-0">MIMOSA</h6>
                                                                    </div>
                                                                    <div class="mapping-details">
                                                                        <div class="mapping-item">
                                                                            <div class="mapping-label">Table:</div>
                                                                            <div class="mapping-value">@mapping.mimosa.entityName</div>
                                                                        </div>
                                                                        <div class="mapping-item">
                                                                            <div class="mapping-label">Field:</div>
                                                                            <div class="mapping-value fw-semibold">@mapping.mimosa.fieldName</div>
                                                                        </div>
                                                                        <div class="mapping-item">
                                                                            <div class="mapping-label">Description:</div>
                                                                            <div class="mapping-value">@mapping.mimosa.description</div>
                                                                        </div>
                                                                        <div class="mapping-item">
                                                                            <div class="mapping-label">Data Type:</div>
                                                                            <div class="mapping-value">@mapping.mimosa.dataType</div>
                                                                        </div>
                                                                        <div class="mapping-item">
                                                                            <div class="mapping-label">Length:</div>
                                                                            <div class="mapping-value">@mapping.mimosa.fieldLength</div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                                <div class="my-3">
                                    <button class="btn btn-link d-flex align-items-center" type="button" onclick="toggleNotes('@document.mapID')" style="text-decoration:none;">
                                        <span class="fw-bold">Note</span>
                                        <span class="ms-2">
                                            <i class="bi bi-chevron-right note-icon" id="notesArrow-@document.mapID"></i>
                                        </span>
                                    </button>
                                    <div class="notes-row" id="notesCollapse-@document.mapID" style="max-height: 0; overflow: hidden; transition: max-height 0.4s ease;">
                                        @{
                                            var notesList = new System.Text.StringBuilder();
                                            int idx = 1;
                                            foreach (var m in document.mappings)
                                            {
                                                var sapField = m.sap?.fieldName ?? "";
                                                var mimosaField = m.mimosa?.fieldName ?? "";
                                                var sapNotes = m.sap?.notes;
                                                var mimosaNotes = m.mimosa?.notes;
                                                if (!string.IsNullOrWhiteSpace(sapNotes) || !string.IsNullOrWhiteSpace(mimosaNotes))
                                                {
                                                    notesList.AppendLine($"Mapping Pair {idx}: SAP Field: {sapField} | MIMOSA Field: {mimosaField}");
                                                    if (!string.IsNullOrWhiteSpace(sapNotes))
                                                        notesList.AppendLine($"  SAP Notes: {sapNotes}");
                                                    if (!string.IsNullOrWhiteSpace(mimosaNotes))
                                                        notesList.AppendLine($"  MIMOSA Notes: {mimosaNotes}");
                                                    notesList.AppendLine("---");
                                                }
                                                idx++;
                                            }
                                        }
                                        <textarea class="form-control mt-2" rows="10" readonly>@notesList</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>


                    </div>
                }
            </div>
        }
    }
</div>


<div class="section">
    <h2>Key Differences Between SAP PM and MIMOSA Data  Models</h2>
    <ol>
        <li>
            <strong>Naming Conventions:</strong>
            <ul>
                <li>SAP PM uses short, often cryptic field names (e.g., AUFNR, AUART)</li>
                <li>MIMOSA uses descriptive, human-readable field names (e.g., WorkOrderID, WorkOrderType)</li>
            </ul>
        </li>
        <li>
            <strong>Data Types:</strong>
            <ul>
                <li>SAP PM has specific length constraints for character fields</li>
                <li>MIMOSA uses more generic data types without explicit length constraints</li>
            </ul>
        </li>
        <li>
            <strong>Relationships:</strong>
            <ul>
                <li>SAP PM uses technical keys for relationships (EQUNR, TPLNR)</li>
                <li>MIMOSA uses more semantic relationship fields (AssetID, LocationID)</li>
            </ul>
        </li>
        <li>
            <strong>Extensions:</strong>
            <ul>
                <li>SAP PM can be extended with custom Z-fields (Z*)</li>
                <li>MIMOSA allows for standard-compliant extensions through its object model</li>
            </ul>
        </li>
    </ol>
</div>


<!-- Modal for displaying historical data -->
<div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="btn-close position-absolute top-0 end-0 m-2" style="background-color: red;" data-bs-dismiss="modal" aria-label="Close"></button>
                <h5 class="modal-title mt-5 ps-2" id="historyModalLabel">Prompt History Details</h5>
            </div>
            <div class="modal-body" id="historyModalBody">
                Loading...
            </div>
            <div class="modal-footer"> 
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        //Search form
        function updateSearchInputName() {
            const searchType = document.querySelector('input[name="SearchType"]:checked').value;
            const searchInput = document.getElementById('searchInput');
            const label = document.getElementById('search-label');
            searchInput.removeAttribute('name');
            if (searchType === 'EntityName') {
                searchInput.name = 'SearchByEntityName';
                // searchInput.placeholder = 'Enter entity name...';
                label.innerHTML = '<i class="bi bi-search me-1"></i> Enter entity name...';
            } else {
                searchInput.name = 'SearchByLLM';
                // searchInput.placeholder = 'Enter LLM type...';
                label.innerHTML = '<i class="bi bi-search me-1"></i> Enter LLM type...';
            }
        }

        function showInputError(inputElem, errorElem, message) {
            errorElem.textContent = message;
            errorElem.style.display = 'block';
            inputElem.classList.add('is-invalid');
        }
        function clearInputError(inputElem, errorElem) {
            errorElem.textContent = '';
            errorElem.style.display = 'none';
            inputElem.classList.remove('is-invalid');
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Update placeholder when radio changes
            document.getElementById('searchEntityName').addEventListener('change', updateSearchInputName);
            document.getElementById('searchLLMType').addEventListener('change', updateSearchInputName);
            updateSearchInputName();
            //input name on submit
            document.getElementById('mappingSearchForm').addEventListener('submit', function(e) {
                updateSearchInputName();
                const searchInput = document.getElementById('searchInput');
                const errorElem = document.getElementById('searchInputError');
                clearInputError(searchInput, errorElem);
                if (!searchInput.value.trim()) {
                    showInputError(searchInput, errorElem, 'Please enter a search value.');
                    e.preventDefault();
                    return false;
                }
            });
            // Set radio button based on which field is filled
            const searchInput = document.getElementById('searchInput');
            if (searchInput.value && !document.getElementById('searchLLMType').checked) {
                document.getElementById('searchEntityName').checked = true;
            } else if (searchInput.value && document.getElementById('searchLLMType').checked) {
                document.getElementById('searchLLMType').checked = true;
            }
        });

        // Display details
        function toggleDetails(mapID) {
            // Hide all other open details rows
            document.querySelectorAll('.details-row').forEach(function(row) {
                if (row.id !== 'details-' + mapID) {
                    row.classList.remove('showing');
                    setTimeout(function() { row.style.display = 'none'; }, 400);
                }
            });
            // Toggle the selected row
            const row = document.getElementById('details-' + mapID);
            if (row && row.style.display === 'none') {
                row.style.display = 'table-row';
                setTimeout(function() { row.classList.add('showing'); }, 10);
            } else if(row) {
                row.classList.remove('showing');
                setTimeout(function() { row.style.display = 'none'; }, 400);
            }
        }

            setTimeout(function() {
            var msg = document.getElementById('success-message');
            if (msg) msg.style.display = 'none';
        }, 5000);

        // Delete
        document.querySelectorAll('.delete-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                const mapID = this.getAttribute('data-mapid');
                if (!confirm('Are you sure you want to delete this mapping document?')) return;

                fetch('@Url.Action("Delete", "Home")/' + mapID, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove the mapping card
                        document.getElementById('group-' + mapID).remove();

                        // Show success message
                        const successMsg = document.createElement('div');
                        successMsg.className = 'alert alert-success';
                        successMsg.textContent = 'Mapping deleted successfully';
                        document.querySelector('.container').insertBefore(successMsg, document.querySelector('.container').firstChild);

                        // Auto-hide after 5 seconds
                        setTimeout(() => {
                            successMsg.remove();
                        }, 5000);
                    } else {
                        alert(data.message || 'Failed to delete mapping.');
                    }
                })
                .catch(err => {
                    alert('Error deleting mapping: ' + err);
                });
            });
        });
    </script>

    <!-- Showing mapping note with notes of all mapping pairs  -->
    <script>
        function toggleNotes(mapID) {
          const currentNote = document.getElementById("notesCollapse-" + mapID);
          const currentArrow = document.getElementById("notesArrow-" + mapID);
          const isOpen = currentNote.classList.contains("open");

          // Close all notes and reset arrows
          document.querySelectorAll(".notes-row").forEach((row) => {
            row.style.maxHeight = "0"
            row.classList.remove("open")
          });
          document.querySelectorAll(".note-icon").forEach((arrow) => {
            arrow.classList.remove("rotated");
          });

          // Open current note
          if (!isOpen) {
            currentNote.classList.add("open")
            currentNote.style.maxHeight = currentNote.scrollHeight + "px"
            currentArrow.classList.add("rotated");
          }
        }
    </script>

    <!-- Displaying historical data -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.prompt-history-item').forEach(function(item) {
                item.addEventListener('click', async function() {
                    const createdAt = this.getAttribute('data-createdat');
                    const mapID = this.getAttribute('data-mapid');
                    const source = this.getAttribute('data-source');
                    if (!createdAt) return;
                    const modal = new bootstrap.Modal(document.getElementById('historyModal'));
                    document.getElementById('historyModalBody').innerHTML = 'Loading...';
                    modal.show();
                    try {
                        let resp;
                        if (source === 'sapmimosa' && mapID) {
                            resp = await fetch(`/Home/GetMappingById?mapID=${mapID}`);
                        } else {
                            resp = await fetch(`/Home/FetchHistoricalData?createdDate=${encodeURIComponent(createdAt)}`);
                        }
                        if (resp.ok) {
                            const data = await resp.json();
                            document.getElementById('historyModalBody').innerHTML = renderHistoricalCardView(data);
                        } else {
                            document.getElementById('historyModalBody').innerHTML = 'Failed to fetch historical data.';
                        }
                    } catch (e) {
                        document.getElementById('historyModalBody').innerHTML = 'Error fetching data: ' + e;
                    }
                });
            });

            // Render mapping details
            function renderMappingDetails(labelMap) {
                return Object.entries(labelMap).map(([label, value]) =>
                    `<div class="mapping-item"><div class="mapping-label">${label}:</div><div class="mapping-value">${value ?? ''}</div></div>`
                ).join('');
            }

            // Render accuracy metrics
            function renderAccuracyMetrics(acc, title='') {
                if (!acc) return '';

                function getBadgeCls(rate) {
                    if (rate < 35) return "bg-danger";
                    if (rate < 70) return "bg-warning text-dark";
                    return "bg-success";
                }
                const badgeCls = getBadgeCls(acc.accuracyRate);
                document.getElementById('historyModalLabel').textContent = title;
                return `
                    <div class="card shadow-sm border-0 mb-3 modern-metrics-card">
                        <div class="card-body p-3">
                            <div class="row g-3 align-items-center">
                                <div class="col-12 col-md-4 text-center mb-3 mb-md-0">
                                    <div class="display-5 fw-bold text-primary">
                                        <i class="bi bi-graph-up-arrow"></i>
                                        <span>${acc.accuracyRate ?? 0}%</span>
                                    </div>
                                    <div class="fw-semibold">Overall Accuracy <i class="bi bi-info-circle ms-1 text-primary" data-bs-toggle="tooltip" title="A total accuracy score is calculated by taking the metrics, SAP Schema Similarity, MIMOSA Schema Similarity, Description Similarity and Data type Similarity but not Table coverage and averaging their scores."></i></div>
                                    <span class="badge ${badgeCls} px-3 py-2 fs-6 mt-2">
                                        ${acc.accuracyRate ?? 0}%
                                    </span>
                                </div>
                                <div class="col-12 col-md-8">
                                    <div class="row g-2">
                                        <div class="col-12 col-sm-6">
                                            <div class="metric-label">Description Similarity</div>
                                            <div class="metric-value"><i class="bi bi-file-earmark-text" data-bs-toggle="tooltip" title="Description similarity compares the meaning of descriptions across a mapping to see if the fields are likely to contain similar information"></i> <strong>${acc.descriptionSimilarity ?? 0}%</strong></div>
                                        </div>
                                        <div class="col-12 col-sm-6">
                                            <div class="metric-label">MIMOSA Schema Similarity</div>
                                            <div class="metric-value"><i class="bi bi-diagram-3" data-bs-toggle="tooltip" title="MIMOSA Schema similarity compares the MIMOSA side of the mapping to to the schema to see if it is a valid field."></i> <strong>${acc.mimosaSimilarity ?? 0}%</strong></div>
                                        </div>
                                        <div class="col-12 col-sm-6">
                                            <div class="metric-label">Data Type Similarity</div>
                                            <div class="metric-value"><i class="bi bi-list-check" data-bs-toggle="tooltip" title="DataType compares the data type between mapped fields to see if they are likely to be able to contain similar data."></i> <strong>${acc.dataType ?? 0}%</strong></div>
                                        </div>
                                        <div class="col-12 col-sm-6">
                                            <div class="metric-label">SAP Schema Similarity</div>
                                            <div class="metric-value"><i class="bi bi-diagram-2" data-bs-toggle="tooltip" title="SAP schema similarity compares the SAP side of the mapping to to the schema to see if it is a valid field"></i> <strong>${acc.sapSimilarity ?? 0}%</strong></div>
                                        </div>
                                        <div class="col-12 col-sm-6 ms-auto">
                                            <div class="metric-label d-flex align-items-center" data-bs-toggle="collapse" data-bs-target="#coverageDetails" style="cursor: pointer;">
                                                Table Coverage
                                                <i class="fas fa-chevron-right ms-2 toggle-icon" id="chevronIcon" style="color:blue; display: inline-block; transition: transform 0.3s;"></i>
                                            </div>
                                            <div class="metric-value"><i class="bi bi-exclamation-circle" data-bs-toggle="tooltip" title="Indicates the percentage of base tables that are currently covered by defined mappings."></i> <strong>${acc.infoOmitted ?? 0}%</strong></div>
                                        </div>
                                                <div class="collapse mt-2" id="coverageDetails">
                                        <div>
                                            ${(() => {
                                                if (acc.missingFields && Object.keys(acc.missingFields).length > 0) {
                                                    let html = '';
                                                    for (const [table, fields] of Object.entries(acc.missingFields)) {
                                                        html += `<b>Table ${table}</b>: ${fields.join(", ")}<br>`;
                                                    }
                                                    return `<div class="form-control" style="min-height: 80px; white-space: pre-wrap;">${html}</div>`;
                                                } else {
                                                    return `<div class="form-control" style="min-height: 80px; white-space: pre-wrap;">No missing fields.</div>`;
                                                }
                                            })()}
                                            <input type="hidden" id="missingFieldsJson" name="accuracyResult.missingFieldsJson" value="" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Render single mapping pair accuracy metrics
            function renderSingleMappingPairAccuracy(acc) {
                if (!acc) return '';
                return `
                    <div class="mt-2 pt-2 accuracy-details-metrics">
                        <div class="fw-semibold mb-2 text-primary"><i class="bi bi-bar-chart"></i>Mapping Pair Accuracy Details</div>
                        <div class="row g-1">
                            <div class="col-6 col-md-4 mb-1">
                                <div class="accuracy-metric-box">
                                    <span class="metric-label"><i class="bi bi-file-earmark-text" data-bs-toggle="tooltip" title="Description similarity compares the meaning of descriptions across a mapping to see if the fields are likely to contain similar information"></i> Desc. Sim.</span>
                                    <span class="metric-value">${acc.descriptionSimilarity ?? 0}%</span>
                                </div>
                            </div>
                            <div class="col-6 col-md-4 mb-1">
                                <div class="accuracy-metric-box">
                                    <span class="metric-label"><i class="bi bi-diagram-2" data-bs-toggle="tooltip" title="SAP schema similarity compares the SAP side of the mapping to to the schema to see if it is a valid field"></i> SAP Sim.</span>
                                    <span class="metric-value">${acc.sapSimilarity ?? 0}%</span>
                                </div>
                            </div>
                            <div class="col-6 col-md-4 mb-1">
                                <div class="accuracy-metric-box">
                                    <span class="metric-label"><i class="bi bi-diagram-3" data-bs-toggle="tooltip" title="MIMOSA Schema similarity compares the MIMOSA side of the mapping to to the schema to see if it is a valid field."></i> MIMOSA Sim.</span>
                                    <span class="metric-value">${acc.mimosaSimilarity ?? 0}%</span>
                                </div>
                            </div>
                            <div class="col-6 col-md-6 mb-1">
                                <div class="accuracy-metric-box">
                                    <span class="metric-label"><i class="bi bi-list-check" data-bs-toggle="tooltip" title="DataType compares the data type between mapped fields to see if they are likely to be able to contain similar data."></i> Data Type</span>
                                    <span class="metric-value">${acc.dataType ?? 0}%</span>
                                </div>
                            </div>
                            <div class="col-6 col-md-6 mb-1">
                                <div class="accuracy-metric-box">
                                    <span class="metric-label"><i class="bi bi-exclamation-circle" data-bs-toggle="tooltip" title=" At an single mapping level it performs same check but only uses the table for that mapping i.e MANDT from table AUFK will only look for fields with table AUFK in the mappings generated, giving an individual table coverage metric."></i> Table Coverage</span>
                                    <span class="metric-value">${acc.infoOmitted ?? 0}%</span>
                                </div>
                            </div>

                        </div>
                    </div>
                `;
            }

            // Main render function
            function renderHistoricalCardView(dataArr) {
                let doc;
                if (Array.isArray(dataArr)) {
                    if (dataArr.length === 0) {
                        return '<div class="alert alert-warning">No historical data found for this prompt.</div>';
                    }
                    doc = dataArr[0];
                } else if (typeof dataArr === 'object' && dataArr !== null) {
                    doc = dataArr;
                } else {
                    return '<div class="alert alert-warning">No historical data found for this prompt.</div>';
                }
                let html = '';

                // Overall accuracy
                if (doc.accuracyResult) {
                    html += renderAccuracyMetrics(doc.accuracyResult, doc.prompt);
                }

                // Mapping pairs
                if (doc.mappings && Array.isArray(doc.mappings)) {
                    html += `<div class="row">` +
                        doc.mappings.map((mapping, idx) => `
                            <div class="col-12 mb-3">
                                <div class="card mapping-pair-card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">Mapping Pair ${idx + 1}</h6>
                                        <div class="badge bg-light text-dark">Field Mapping</div>
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="row g-0">
                                            <div class="col-md-6 sap-side">
                                                <div class="p-3 h-100 border-end-md">
                                                    <div class="d-flex align-items-center mb-3">
                                                        <div class="sap-indicator me-2"></div>
                                                        <h6 class="mb-0">SAP</h6>
                                                    </div>
                                                    <div class="mapping-details">
                                                        ${renderMappingDetails({
                                                            'Table': mapping.sap.entityName,
                                                            'Field': `<span class=\"fw-semibold\">${mapping.sap.fieldName}</span>`,
                                                            'Description': mapping.sap.description,
                                                            'Data Type': mapping.sap.dataType,
                                                            'Length': mapping.sap.fieldLength
                                                        })}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mimosa-side">
                                                <div class="p-3 h-100">
                                                    <div class="d-flex align-items-center mb-3">
                                                        <div class="mimosa-indicator me-2"></div>
                                                        <h6 class="mb-0">MIMOSA</h6>
                                                    </div>
                                                    <div class="mapping-details">
                                                        ${renderMappingDetails({
                                                            'Table': mapping.mimosa.entityName,
                                                            'Field': `<span class=\"fw-semibold\">${mapping.mimosa.fieldName}</span>`,
                                                            'Description': mapping.mimosa.description,
                                                            'Data Type': mapping.mimosa.dataType,
                                                            'Length': mapping.mimosa.fieldLength
                                                        })}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        ${renderSingleMappingPairAccuracy(doc.accuracySingleMappingPair?.[idx])}
                                    </div>
                                </div>
                            </div>
                        `).join('') +
                    `</div>`;
                }
                return html;
            }
        });
    </script>
}

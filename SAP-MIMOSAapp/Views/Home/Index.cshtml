@model List<SAP_MIMOSAapp.Models.MappingDocument>


<h1>Generate Mapping Between SAP PM & MIMOSA </h1>

<div class="section">
    <div class="row">
        <div class="col-md-12 mb-4">
            <!-- Search Controls -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Search Mappings</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <form id="mappingSearchForm" method="get" action="@Url.Action("Index", "Home")">
                                <div class="mb-3">
                                    <label for="searchQuery" class="form-label">Search</label>
                                    <input type="text" id="searchQuery" name="mapID" class="form-control" placeholder="Enter search term..." value="@ViewBag.SearchedMapID" />
                                </div>
                                <div class="mb-3">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="searchType" id="searchMapID" value="mapID" checked>
                                        <label class="form-check-label" for="searchMapID">Search by Map ID</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="searchType" id="searchLLMType" value="LLMType">
                                        <label class="form-check-label" for="searchLLMType">Search by LLM Type</label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <button type="submit" class="btn btn-primary">Search</button>
                                    <a href="@Url.Action("Index", "Home")" class="btn btn-secondary">Clear</a>
                                </div>
                                @if (ViewBag.SearchedMapID != null || ViewBag.SearchedLLMType!=null)
                                {
                                    <div class="mt-2">
                                        <small class="text-muted">
                                            Found @ViewBag.FilteredCount mapping(s) out of @ViewBag.TotalDocuments total mappings.
                                        </small>
                                    </div>
                                }
                            </form>
                        </div>

                        <!-- AI Assistant Search -->
                        <div class="col-md-6">
                            <form id="aiSearchForm" method="get" action="@Url.Action("Index", "Home")">
                                <div class="mb-3">
                                    <label for="queryInput" class="form-label">AI Assistant</label>
                                    <input type="text" id="queryInput" name="query" class="form-control"
                                           placeholder="Ask a question about SAP-MIMOSA mapping..." />
                                </div>
                                <div class="mb-3">
                                    <button type="submit" class="btn btn-primary">Ask AI</button>
                                </div>
                            </form>

                            <!-- display AI response -->
                            <div id="aiResponse">
                                @if (ViewBag.AIResponse != null)
                                {
                                    <div class="alert alert-info">
                                        <h4>AI Response:</h4>
                                        <p>@Html.Raw(ViewBag.AIResponse?.Replace("\n", "<br/>"))</p>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <button id="resetButton" class="btn btn-warning">Reset All Colors</button>
        <a href="@Url.Action("Create", "Home")" class="btn btn-primary">Create New Mapping</a>
    </div>

    <!-- Mapping Table with Complex Header -->
    <div class="table-responsive">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th rowspan="2" class="align-middle">Map ID</th>
                    <th rowspan="2" class="align-middle">LLM Type</th>
                    <th colspan="6" class="text-center border-bottom" style="background-color: cadetblue !important;">SAP</th>
                    <th colspan="6" class="text-center border-bottom " style="background-color: seagreen !important;">MIMOSA</th>
                    @* <th rowspan="2" class="align-middle">Actions</th> *@
                </tr>
                <tr style="white-space:nowrap;">
                    <!-- SAP columns -->
                    @* <th>Platform</th> *@
                    <th>Table Name</th>
                    <th>Field Name</th>
                    <th>Description</th>
                    <th>Data Type</th>
                    <th style="border-right: 3px solid gray;">Length</th>

                    <!-- MIMOSA columns -->
                    @* <th>Platform</th> *@
                    <th>Table Name</th>
                    <th>Field Name</th>
                    <th>Description</th>
                    <th>Data Type</th>
                    <th>Length</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Count == 0)
                {
                    <tr>
                        <td colspan="15" class="text-center">No mappings found.</td>
                    </tr>
                }
                else
                {
                    @foreach (var document in Model)
                    {
                        bool isFirstMapping = true;
                        int mappingCount = document.mappings.Count;

                        @foreach (var mapping in document.mappings)
                        {
                            <tr id="row_@document.mapID" style="background-color: @(isFirstMapping ? document.Color : null)">
                                @if (isFirstMapping)
                                {
                                    <td rowspan="@mappingCount" class="align-middle border-right" id="mapID_@document.mapID">
                                        <div class="d-flex flex-column align-items-center  gap-2 ">
                                            <span class="fw-bolder mt-5 fs-4">@document.mapID</span>
                                                <hr class="w-100" />
                                            <div class="d-flex flex-column justify-content-center gap-2 w-100">
                                                <a href="@Url.Action("Edit", "Home", new { id = document.mapID })" class="btn btn-primary btn-sm mb-2">Edit</a>
                                                <form method="post" action="@Url.Action("Delete", "Home", new { id = document.mapID })" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this mapping document?');">
                                                    <button type="submit" class="btn btn-danger btn-sm w-100">Delete</button>
                                                </form>
                                            </div>
                                            @if (isFirstMapping)
                                            {
                                                <div class="d-flex align-items-center mt-3 mb-4" style="background-color:blanchedalmond;">
                                                    <i class="fas fa-paint-brush change-color-icon green" data-id="@document.mapID" style="cursor: pointer; font-size: 23px; color: green; " title="Green"></i>
                                                    <i class="fas fa-paint-brush change-color-icon red" data-id="@document.mapID" style="cursor: pointer; font-size: 23px; color: red; " title="Red"></i>
                                                    <i class="fas fa-paint-brush change-color-icon yellow" data-id="@document.mapID" style="cursor: pointer; font-size: 23px; color: yellow;" title="Yellow"></i>
                                                    <i class="fas fa-paint-brush change-color-icon white" data-id="@document.mapID" style="cursor: pointer; font-size: 23px; color: white;" title="Reset Color"></i>
                                                </div>
                                            }
                                        </div>
                                    </td>
                                    <td rowspan="@mappingCount" class="align-middle border-right">@document.llmType</td>
                                }

                                <!-- SAP fields -->
                                @* <td>@mapping.sap.Platform</td> *@
                                <td>@mapping.sap.entityName</td>
                                <td>@mapping.sap.fieldName</td>
                                <td>@mapping.sap.description</td>
                                <td>@mapping.sap.DataType</td>
                                <td style="border-right: 3px solid gray;">@mapping.sap.FieldLength</td>

                                <!-- MIMOSA fields -->
                                @* <td>@mapping.mimosa.Platform</td> *@
                                <td>@mapping.mimosa.entityName</td>
                                <td>@mapping.mimosa.fieldName</td>
                                <td>@mapping.mimosa.description</td>
                                <td>@mapping.mimosa.DataType</td>
                                <td>@mapping.mimosa.FieldLength</td>

                                @* @if (isFirstMapping) *@
                                @* { *@
                                @*     <td rowspan="@mappingCount" class="align-middle"> *@
                                @*         <div class="d-flex flex-column"> *@
                                @*             <a href="@Url.Action("Edit", "Home", new { id = document.mapID })" class="btn btn-primary btn-sm mb-2">Edit</a> *@
                                @*             <form method="post" action="@Url.Action("Delete", "Home", new { id = document.mapID })" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this mapping document?');"> *@
                                @*                 <button type="submit" class="btn btn-danger btn-sm">Delete</button> *@
                                @*             </form> *@
                                @*         </div> *@
                                @*     </td> *@
                                @* } *@
                            </tr>

                            isFirstMapping = false;
                        }
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<div class="section mt-4">
    <h2>Key Differences Between SAP PM and MIMOSA Work Order Models</h2>
    <ol>
        <li>
            <strong>Naming Conventions:</strong>
            <ul>
                <li>SAP PM uses short, often cryptic field names (e.g., AUFNR, AUART)</li>
                <li>MIMOSA uses descriptive, human-readable field names (e.g., WorkOrderID, WorkOrderType)</li>
            </ul>
        </li>
        <li>
            <strong>Data Types:</strong>
            <ul>
                <li>SAP PM has specific length constraints for character fields</li>
                <li>MIMOSA uses more generic data types without explicit length constraints</li>
            </ul>
        </li>
        <li>
            <strong>Relationships:</strong>
            <ul>
                <li>SAP PM uses technical keys for relationships (EQUNR, TPLNR)</li>
                <li>MIMOSA uses more semantic relationship fields (AssetID, LocationID)</li>
            </ul>
        </li>
        <li>
            <strong>Extensions:</strong>
            <ul>
                <li>SAP PM can be extended with custom Z-fields (Z*)</li>
                <li>MIMOSA allows for standard-compliant extensions through its object model</li>
            </ul>
        </li>
    </ol>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Change color when an icon is clicked
            $(".change-color-icon").on("click", function () {
                var mapID = $(this).data("id");
                var newColor = $(this).css("color");

                // Update the background color on all rows for this mapID
                $("tr[id='row_" + mapID + "']").css("background-color", newColor);
                $("#mapID_" + mapID).css("background-color", newColor);

                // Send the color change to the server via AJAX
                $.ajax({
                    url: '@Url.Action("ChangeColor", "Home")',
                    type: 'POST',
                    data: {
                        id: mapID,
                        color: newColor
                    },
                    success: function () {
                        console.log("Color updated successfully!");
                    },
                    error: function () {
                        alert("Error saving color change.");
                    }
                });
            });

            // Reset all colors when the reset button is clicked
            $("#resetButton").on("click", function () {
                // Send a reset request to the server
                $.ajax({
                    url: '@Url.Action("ResetColors", "Home")',
                    type: 'POST',
                    success: function () {
                        // Reset all colors
                        $("tr[id^='row_']").css("background-color", "");
                        $("td[id^='mapID_']").css("background-color", "");

                        alert("All colors have been reset.");
                    },
                    error: function () {
                        alert("Error resetting colors.");
                    }
                });
            });

            // Add loading indicator when form is submitted
            $("#aiSearchForm").on("submit", function() {
                $("#aiResponse").html('<div class="alert alert-info">Loading response...</div>');
                // Continue with form submission
                return true;
            });

            // Handle search type change
            $('input[name="searchType"]').on('change', function() {
                const searchType = $(this).val();
                const searchInput = $('#searchQuery');

                if (searchType === 'mapID') {
                    searchInput.attr('name', 'mapID');
                    searchInput.attr('placeholder', 'Enter Map ID...');
                } else {
                    searchInput.attr('name', 'llmType');
                    searchInput.attr('placeholder', 'Enter LLM Type...');
                }
            });
        });
    </script>
}

